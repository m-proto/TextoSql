name: TextToSQL CI/CD

# Quand dÃ©clencher le workflow
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Variables d'environnement globales
env:
  PYTHON_VERSION: '3.11'

# Les Ã©tapes du workflow
jobs:
  # Job 1: Tests et validation
  test:
    runs-on: ubuntu-latest
    
    steps:
    # Ã‰tape 1: RÃ©cupÃ©rer le code
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    # Ã‰tape 2: Installer Python
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # Ã‰tape 3: Cache des dÃ©pendances (pour aller plus vite)
    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # Ã‰tape 4: Installer les dÃ©pendances
    - name: ğŸ“š Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed"
    
    # Ã‰tape 5: Test des imports (le plus important)
    - name: ğŸ§ª Test imports
      run: |
        echo "ğŸ” Testing all imports..."
        python test_imports.py
        echo "âœ… All imports successful"
    
    # Ã‰tape 6: VÃ©rification de la syntaxe
    - name: ğŸ” Syntax check
      run: |
        echo "ğŸ“ Checking Python syntax..."
        python -m py_compile api.py
        python -m py_compile core/*.py
        echo "âœ… Syntax check passed"
    
    # Ã‰tape 7: Test de dÃ©marrage API (sans DB)
    - name: ğŸš€ Test API structure
      run: |
        echo "ğŸ§ª Testing API structure..."
        python -c "
from api import app
from fastapi.testclient import TestClient
print('âœ… API structure is valid')
print(f'âœ… App title: {app.title}')
print(f'âœ… API version: {app.version}')
"
    
    # Ã‰tape 8: VÃ©rification des endpoints
    - name: ğŸ”— Check endpoints
      run: |
        echo "ğŸ” Checking API endpoints..."
        python -c "
from api import app
routes = [route.path for route in app.routes if hasattr(route, 'path')]
print('âœ… API endpoints found:')
for route in routes:
    print(f'  - {route}')
"
    
    # Ã‰tape 9: Test de sÃ©curitÃ© basique
    - name: ğŸ›¡ï¸ Security check
      run: |
        echo "ğŸ”’ Basic security check..."
        python -c "
import os
# VÃ©rifier qu'il n'y a pas de credentials hardcodÃ©s
with open('api.py', 'r') as f:
    content = f.read()
    if 'k_shiraishi' in content or 'Eb{T~Dbk' in content:
        print('âŒ Hardcoded credentials found!')
        exit(1)
    else:
        print('âœ… No hardcoded credentials found')
"

  # Job 2: Build et dÃ©ploiement (seulement si tests passent)
  deploy:
    needs: test  # Attend que le job 'test' soit terminÃ© avec succÃ¨s
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Seulement sur main
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy to Render
      run: |
        echo "ğŸ‰ Tests passed! Deploying to Render..."
        echo "ğŸ“¡ Render will automatically deploy from main branch"
        echo "ğŸ”— Your API will be available at: https://textosql-api.onrender.com"
    
    # Ã‰tape optionnelle: Attendre et tester le dÃ©ploiement
    - name: â³ Wait for deployment
      run: |
        echo "â³ Waiting for Render deployment..."
        sleep 60
    
    - name: ğŸ¥ Health check after deployment
      run: |
        echo "ğŸ¥ Testing deployed API..."
        # Remplacez par votre vraie URL Render quand vous l'aurez
        echo "curl -f https://textosql-api.onrender.com/health"
        echo "âœ… Deployment health check (simulated)"
    
    - name: ğŸ“§ Notify success
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸ“Š Your API is live and ready to use!"
